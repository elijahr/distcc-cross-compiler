# Rendered from .github/workflows/build.yml.jinja

name: Build archlinux images

on:
  push:
    branches: ['*']
    tags: ['*']

jobs:
  build-amd64-host:
    name: |
      Build archlinux host amd64
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Install emulation dependencies
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Install pip requirements
      run: |
        pip install -r requirements.txt

    - name: Build host image
      run: |
        ./builder.py build-host archlinux amd64

  build-amd64-clients:
    name: |
      Build archlinux client ${{ matrix.compiler_arch }} (host: amd64)
    runs-on: ubuntu-latest
    depends-on: build-amd64-host

    strategy:
      matrix:
        include:
        - host_arch: amd64
          compiler_arch: amd64

        - host_arch: amd64
          compiler_arch: arm32v5

        - host_arch: amd64
          compiler_arch: arm32v6

        - host_arch: amd64
          compiler_arch: arm32v7

        - host_arch: amd64
          compiler_arch: arm64v8


    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Install emulation dependencies
      run: |
        sudo apt-get update -q -y
        sudo apt-get -qq install -y qemu qemu-user-static
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

    - name: Install pip requirements
      run: |
        pip install -r requirements.txt

    - name: Build client image
      run: |
        ./builder.py build-client archlinux amd64 ${{ matrix.compiler_arch }}



  push_manifests:
    name: Push manifests
    if: ${{ github.event_name == 'push' && startsWith(github.event.ref, 'refs/tags/')
      }}

    runs-on: ubuntu-latest
    needs: build

    strategy:
      matrix:
        version: [latest, '${{ github.ref }}']

    steps:
    - name: Checkout repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 1
        submodules: recursive


    - name: Push manifest
      run: |-
        echo ${{ secrets.DOCKERHUB_TOKEN }} | docker login \
          -u elijahru --password-stdin
        docker images
        ./scripts/push-manifests-debian.sh \
          $(basename ${{ matrix.version }}) \
          debian-buster
